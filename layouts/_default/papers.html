{{ define "main" }}
{{ $featured := or .Params.featured_image .Params.featuredImage }}
{{ $allPaperPages := where site.Pages "Section" "papers-items" }}
{{ $allPapers := sort (where $allPaperPages "Kind" "page") "Params.sort_key" "desc" }}
{{ $preprints := where $allPapers "Params.category" "preprint" }}
{{ $journals := where $allPapers "Params.category" "journal" }}
{{ $thesis := where $allPapers "Params.category" "thesis" }}
{{ $conferences := where $allPapers "Params.category" "conference" }}
{{ $others := where $allPapers "Params.category" "other" }}
{{ $manuscripts := where $allPapers "Params.category" "manuscript" }}
<article class="page page-papers">
  {{ partial "breadcrumb.html" . }}
  <header class="page-header"><h1>{{ .Title }}</h1></header>
  {{ if $featured }}
  <figure class="post-featured">
    {{ partial "responsive-image.html" (dict "src" $featured "alt" .Title "class" "post-featured-image markdown-image" "page" . "sizes" "(min-width: 860px) 860px, 100vw") }}
  </figure>
  {{ end }}
  <section class="page-body">
    <div class="papers-search" role="search">
      <label for="papers-search-input">Search papers</label>
      <input id="papers-search-input" type="search" placeholder="Title, coauthor, venue, year..." autocomplete="off">
      <details class="papers-coauthors">
        <summary>Filter by Coauthors</summary>
        <div id="papers-coauthor-buttons" class="papers-coauthor-buttons"></div>
      </details>
      <details class="papers-coauthors">
        <summary>Filter by Journals</summary>
        <div id="papers-journal-buttons" class="papers-coauthor-buttons"></div>
      </details>
      <p id="papers-search-status" class="papers-search-status" aria-live="polite"></p>
    </div>

    <h2>Preprints</h2>
    {{ partial "paper-list.html" (dict "papers" $preprints) }}
    <p><a href="https://arxiv.org/a/oum_s_1.html">My papers on arXiv</a></p>

    <h2>Journal Papers</h2>
    {{ partial "paper-list.html" (dict "papers" $journals "group_by_year" true) }}

    <h2>Ph.D. Thesis</h2>
    {{ partial "paper-list.html" (dict "papers" $thesis) }}

    <h2>Conference Papers</h2>
    {{ partial "paper-list.html" (dict "papers" $conferences "group_by_year" true) }}

    <h2>Other</h2>
    {{ partial "paper-list.html" (dict "papers" $others) }}

    <h2>Manuscripts</h2>
    {{ partial "paper-list.html" (dict "papers" $manuscripts) }}

    <p>
      <a href="https://mathscinet.ams.org/mathscinet/search/author.html?mrauthid=765385">AMS MathSciNet Author ID: 765385</a><br>
      <a href="https://www.scopus.com/authid/detail.uri?authorId=55912957400">Scopus Author ID: 55912957400</a><br>
      <a href="https://publons.com/researcher/2805090/sang-il-oum/">ResearchID: C-1692-2011</a><br>
      <a href="https://scholar.google.com/citations?user=EsMssA0AAAAJ&hl=en">Google Scholar</a>
    </p>
  </section>
</article>

<script>
  (function () {
    var input = document.getElementById("papers-search-input");
    var status = document.getElementById("papers-search-status");
    var coauthorBox = document.getElementById("papers-coauthor-buttons");
    var journalBox = document.getElementById("papers-journal-buttons");
    if (!input || !coauthorBox || !journalBox) return;

    var coauthorMap =
      {{- $coauthorMap := dict -}}
      {{- range site.Data.people -}}
        {{- $name := printf "%s%s%s" .firstname (cond (ne .lastname "") " " "") .lastname -}}
        {{- $coauthorMap = merge $coauthorMap (dict .id $name) -}}
      {{- end -}}
      {{- $coauthorMap | jsonify | safeJS -}};

    var items = Array.prototype.slice.call(document.querySelectorAll(".paper-list .paper-item"));
    var lists = Array.prototype.slice.call(document.querySelectorAll(".paper-list"));
    var total = items.length;
    var NONE_COAUTHOR_KEY = "__none__";
    var activeCoauthor = null;
    var activeJournal = null;

    function normalize(text) { return (text || "").toLowerCase().trim(); }
    function getItemCoauthors(item) {
      if (!item.dataset.coauthors) return [];
      return item.dataset.coauthors.split(",").map(function (s) { return s.trim(); }).filter(Boolean);
    }
    function getItemJournal(item) { return (item.dataset.journal || "").trim(); }

    function updateStatus(shown, query) {
      if (!status) return;
      if (!query && !activeCoauthor && !activeJournal) {
        status.textContent = "Showing all " + total + " papers.";
        return;
      }
      var parts = [];
      if (query) parts.push("query \"" + query + "\"");
      if (activeCoauthor) {
        if (activeCoauthor === NONE_COAUTHOR_KEY) parts.push("coauthor \"None\"");
        else parts.push("coauthor \"" + (coauthorMap[activeCoauthor] || activeCoauthor) + "\"");
      }
      if (activeJournal) parts.push("journal \"" + activeJournal + "\"");
      status.textContent = "Found " + shown + " paper" + (shown === 1 ? "" : "s") + " for " + parts.join(" + ") + ".";
    }

    function refreshYearHeaders() {
      lists.forEach(function (list) {
        var prev = list.previousElementSibling;
        if (prev && prev.tagName === "H3") prev.hidden = list.hidden;
      });
    }

    function applyFilter() {
      var query = normalize(input.value);
      var shown = 0;
      items.forEach(function (item) {
        var text = normalize(item.textContent);
        var itemCoauthors = getItemCoauthors(item);
        var itemJournal = getItemJournal(item);
        var queryOk = !query || text.indexOf(query) !== -1;
        var coauthorOk = !activeCoauthor || (activeCoauthor === NONE_COAUTHOR_KEY ? itemCoauthors.length === 0 : itemCoauthors.indexOf(activeCoauthor) !== -1);
        var journalOk = !activeJournal || itemJournal === activeJournal;
        var visible = queryOk && coauthorOk && journalOk;
        item.hidden = !visible;
        if (visible) shown += 1;
      });
      lists.forEach(function (list) { list.hidden = !list.querySelector(".paper-item:not([hidden])"); });
      refreshYearHeaders();
      updateStatus(shown, query);
      updateCoauthorButtonState();
      updateJournalButtonState();
    }

    function updateCoauthorButtonState() {
      var resetBtn = coauthorBox.querySelector("button[data-coauthor-all]");
      if (resetBtn) resetBtn.classList.toggle("is-active", !activeCoauthor);
      Array.prototype.slice.call(coauthorBox.querySelectorAll("button[data-coauthor]")).forEach(function (button) {
        var cid = button.getAttribute("data-coauthor");
        button.classList.toggle("is-active", cid === activeCoauthor);
      });
    }

    function updateJournalButtonState() {
      var resetBtn = journalBox.querySelector("button[data-journal-all]");
      if (resetBtn) resetBtn.classList.toggle("is-active", !activeJournal);
      Array.prototype.slice.call(journalBox.querySelectorAll("button[data-journal]")).forEach(function (button) {
        var jid = button.getAttribute("data-journal");
        button.classList.toggle("is-active", jid === activeJournal);
      });
    }

    function renderCoauthorButtons() {
      var counts = {};
      var noneCount = 0;
      items.forEach(function (item) {
        var c = getItemCoauthors(item);
        if (c.length === 0) noneCount += 1;
        c.forEach(function (id) { counts[id] = (counts[id] || 0) + 1; });
      });
      var rows = Object.keys(counts).map(function (cid) { return { id: cid, name: coauthorMap[cid] || cid, count: counts[cid] }; }).sort(function (a, b) { if (b.count !== a.count) return b.count - a.count; return a.name.localeCompare(b.name); });
      var frag = document.createDocumentFragment();
      var reset = document.createElement("button");
      reset.type = "button"; reset.className = "papers-coauthor-btn is-active"; reset.setAttribute("data-coauthor-all", "1"); reset.textContent = "All (" + total + ")";
      reset.addEventListener("click", function () { activeCoauthor = null; applyFilter(); });
      frag.appendChild(reset);
      var noneBtn = document.createElement("button");
      noneBtn.type = "button"; noneBtn.className = "papers-coauthor-btn"; noneBtn.setAttribute("data-coauthor", NONE_COAUTHOR_KEY); noneBtn.textContent = "None (" + noneCount + ")";
      noneBtn.addEventListener("click", function () { activeCoauthor = (activeCoauthor === NONE_COAUTHOR_KEY) ? null : NONE_COAUTHOR_KEY; applyFilter(); });
      frag.appendChild(noneBtn);
      rows.forEach(function (row) {
        var btn = document.createElement("button");
        btn.type = "button"; btn.className = "papers-coauthor-btn"; btn.setAttribute("data-coauthor", row.id); btn.textContent = row.name + " (" + row.count + ")";
        btn.addEventListener("click", function () { activeCoauthor = (activeCoauthor === row.id) ? null : row.id; applyFilter(); });
        frag.appendChild(btn);
      });
      coauthorBox.appendChild(frag);
    }

    function renderJournalButtons() {
      var counts = {};
      items.forEach(function (item) { var j = getItemJournal(item); if (j) counts[j] = (counts[j] || 0) + 1; });
      var rows = Object.keys(counts).map(function (name) { return { name: name, count: counts[name] }; }).sort(function (a, b) { if (b.count !== a.count) return b.count - a.count; return a.name.localeCompare(b.name); });
      var frag = document.createDocumentFragment();
      var reset = document.createElement("button");
      reset.type = "button"; reset.className = "papers-coauthor-btn is-active"; reset.setAttribute("data-journal-all", "1"); reset.textContent = "All";
      reset.addEventListener("click", function () { activeJournal = null; applyFilter(); });
      frag.appendChild(reset);
      rows.forEach(function (row) {
        var btn = document.createElement("button");
        btn.type = "button"; btn.className = "papers-coauthor-btn"; btn.setAttribute("data-journal", row.name); btn.textContent = row.name + " (" + row.count + ")";
        btn.addEventListener("click", function () { activeJournal = (activeJournal === row.name) ? null : row.name; applyFilter(); });
        frag.appendChild(btn);
      });
      journalBox.appendChild(frag);
    }

    input.addEventListener("input", applyFilter);
    renderCoauthorButtons();
    renderJournalButtons();
    applyFilter();
  })();
</script>
{{ end }}
