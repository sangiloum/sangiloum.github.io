{{ define "main" }}
{{ $featured := or .Params.featured_image .Params.featuredImage }}
{{ $allStudentPaperPages := where site.Pages "Section" "student-papers-items" }}
{{ $allPapers := sort (where $allStudentPaperPages "Kind" "page") "Params.sort_key" "desc" }}
{{ $journalPapers := where $allPapers "Params.category" "journal" }}
{{ $journalSubmitted := where $journalPapers "Params.subcategory" "submitted" }}
{{ $journalPublished := slice }}
{{ range $journalPapers }}
  {{ if ne .Params.subcategory "submitted" }}
    {{ $journalPublished = $journalPublished | append . }}
  {{ end }}
{{ end }}
{{ $conferencePapers := where $allPapers "Params.category" "conference" }}
<article class="page page-students">
  {{ partial "breadcrumb.html" . }}
  <header class="page-header"><h1>{{ .Title }}</h1></header>
  {{ if $featured }}
  <figure class="post-featured">
    {{ partial "responsive-image.html" (dict "src" $featured "alt" .Title "class" "post-featured-image markdown-image" "page" . "sizes" "(min-width: 860px) 860px, 100vw") }}
  </figure>
  {{ end }}
  <section class="page-body">
    <h3>Current Graduate Students</h3>
    {{ partial "student-current-list.html" . }}

    <h3>Current Postdocs</h3>
    {{ partial "postdoc-current-list.html" . }}

    <h3>Former Graduate Students</h3>
    {{ partial "student-former-list.html" . }}

    <h3>Former Postdocs</h3>
    {{ partial "postdoc-former-carousel.html" . }}

    <h1>Papers written by my students <em>NOT</em> coauthored with me</h1>
    <p>I am not a co-author of some of the papers of my students. Below, I try to list such papers.</p>

    <div class="papers-search" role="search">
      <label for="students-search-input">Search student papers</label>
      <input id="students-search-input" type="search" placeholder="Title, student, venue, year..." autocomplete="off">
      <details class="papers-coauthors">
        <summary>Filter by Students</summary>
        <div id="students-filter-buttons" class="papers-coauthor-buttons"></div>
      </details>
      <p id="students-search-status" class="papers-search-status" aria-live="polite"></p>
    </div>

    <h2>Journal papers</h2>
    <h3>Submitted</h3>
    {{ partial "student-paper-list.html" (dict "papers" $journalSubmitted) }}
    {{ partial "student-paper-list.html" (dict "papers" $journalPublished "group_by_year" true) }}

    <h2>Refereed Conference Papers</h2>
    {{ partial "student-paper-list.html" (dict "papers" $conferencePapers "group_by_year" true) }}
  </section>
</article>

<script>
(function () {
  var input = document.getElementById("students-search-input");
  var status = document.getElementById("students-search-status");
  var filterBox = document.getElementById("students-filter-buttons");
  if (!input || !filterBox) return;

  var studentMap =
    {{- $studentMap := dict -}}
    {{- range site.Data.people -}}
      {{- $name := printf "%s%s%s" .firstname (cond (ne .lastname "") " " "") .lastname -}}
      {{- $studentMap = merge $studentMap (dict .id $name) -}}
    {{- end -}}
    {{- $studentMap | jsonify | safeJS -}};

  var items = Array.prototype.slice.call(document.querySelectorAll(".paper-list .student-paper-item"));
  var lists = Array.prototype.slice.call(document.querySelectorAll(".paper-list"));
  var total = items.length;
  var activeStudent = null;

  function normalize(text) { return (text || "").toLowerCase().trim(); }
  function getItemStudents(item) {
    if (!item.dataset.mystudents) return [];
    return item.dataset.mystudents.split(",").map(function (s) { return s.trim(); }).filter(Boolean);
  }

  function updateStatus(shown, query) {
    if (!status) return;
    if (!query && !activeStudent) { status.textContent = "Showing all " + total + " student papers."; return; }
    var parts = [];
    if (query) parts.push("query \"" + query + "\"");
    if (activeStudent) parts.push("student \"" + (studentMap[activeStudent] || activeStudent) + "\"");
    status.textContent = "Found " + shown + " paper" + (shown === 1 ? "" : "s") + " for " + parts.join(" + ") + ".";
  }

  function applyFilter() {
    var query = normalize(input.value);
    var shown = 0;
    items.forEach(function (item) {
      var text = normalize(item.textContent);
      var itemStudents = getItemStudents(item);
      var visible = (!query || text.indexOf(query) !== -1) && (!activeStudent || itemStudents.indexOf(activeStudent) !== -1);
      item.hidden = !visible;
      if (visible) shown += 1;
    });
    lists.forEach(function (list) {
      var hasVisible = !!list.querySelector(".student-paper-item:not([hidden])");
      list.hidden = !hasVisible;
      var prev = list.previousElementSibling;
      if (prev && prev.tagName === "H3") prev.hidden = list.hidden;
    });
    updateStatus(shown, query);
    var resetBtn = filterBox.querySelector("button[data-student-all]");
    if (resetBtn) resetBtn.classList.toggle("is-active", !activeStudent);
    Array.prototype.slice.call(filterBox.querySelectorAll("button[data-student]")).forEach(function (button) {
      button.classList.toggle("is-active", button.getAttribute("data-student") === activeStudent);
    });
  }

  function renderFilterButtons() {
    var counts = {};
    items.forEach(function (item) {
      getItemStudents(item).forEach(function (sid) { counts[sid] = (counts[sid] || 0) + 1; });
    });
    var rows = Object.keys(counts).map(function (sid) { return { id: sid, name: studentMap[sid] || sid, count: counts[sid] }; })
      .sort(function (a, b) { if (b.count !== a.count) return b.count - a.count; return a.name.localeCompare(b.name); });

    var frag = document.createDocumentFragment();
    var reset = document.createElement("button");
    reset.type = "button"; reset.className = "papers-coauthor-btn is-active"; reset.setAttribute("data-student-all", "1"); reset.textContent = "All (" + total + ")";
    reset.addEventListener("click", function () { activeStudent = null; applyFilter(); });
    frag.appendChild(reset);

    rows.forEach(function (row) {
      var btn = document.createElement("button");
      btn.type = "button"; btn.className = "papers-coauthor-btn"; btn.setAttribute("data-student", row.id); btn.textContent = row.name + " (" + row.count + ")";
      btn.addEventListener("click", function () { activeStudent = (activeStudent === row.id) ? null : row.id; applyFilter(); });
      frag.appendChild(btn);
    });

    filterBox.appendChild(frag);
  }

  input.addEventListener("input", applyFilter);
  renderFilterButtons();
  applyFilter();
})();

(function () {
  var carousel = document.querySelector("[data-former-postdocs-carousel]");
  if (!carousel) return;

  var cards = Array.prototype.slice.call(carousel.querySelectorAll(".former-postdoc-card"));
  var prevBtn = carousel.querySelector("[data-former-postdocs-prev]");
  var nextBtn = carousel.querySelector("[data-former-postdocs-next]");
  var positionText = carousel.querySelector("[data-former-postdocs-position]");
  if (!cards.length || !prevBtn || !nextBtn || !positionText) return;

  var reducedMotionQuery = window.matchMedia("(prefers-reduced-motion: reduce)");
  var mobileQuery = window.matchMedia("(max-width: 900px)");
  var autoRotateTimer = null;
  var autoRotateInterval = 4500;
  var activeIndex = 0;

  function mod(index, length) {
    return ((index % length) + length) % length;
  }

  function getRelativeIndex(index) {
    var diff = index - activeIndex;
    if (diff > cards.length / 2) diff -= cards.length;
    if (diff < -cards.length / 2) diff += cards.length;
    return diff;
  }

  function updatePositionBanner() {
    var activeCard = cards[activeIndex];
    if (!activeCard) return;
    var nextText = activeCard.getAttribute("data-current-position") || "Current position not available.";
    positionText.textContent = nextText;
    positionText.classList.remove("is-animating");
    void positionText.offsetWidth;
    positionText.classList.add("is-animating");
  }

  function renderStatic() {
    cards.forEach(function (card, index) {
      card.classList.remove("is-active", "is-prev", "is-next", "is-hidden");
      card.style.transform = "";
      card.style.opacity = "";
      card.style.zIndex = "";
      card.style.pointerEvents = "";
      card.setAttribute("aria-hidden", "false");
      card.tabIndex = (index === activeIndex) ? 0 : -1;
    });
    updatePositionBanner();
  }

  function render3d() {
    cards.forEach(function (card, index) {
      var rel = getRelativeIndex(index);
      card.classList.remove("is-active", "is-prev", "is-next", "is-hidden");
      card.style.pointerEvents = "";
      card.style.opacity = "";

      if (rel === 0) {
        card.classList.add("is-active");
      } else if (rel === -1) {
        card.classList.add("is-prev");
      } else if (rel === 1) {
        card.classList.add("is-next");
      } else {
        card.classList.add("is-hidden");
      }

      if (Math.abs(rel) > 2) {
        card.style.transform = "translateX(-50%) translate3d(" + (rel * 56) + "px, 0, -360px) rotateY(" + (rel * -24) + "deg) scale(0.72)";
        card.style.opacity = "0";
        card.style.zIndex = "1";
        card.style.pointerEvents = "none";
      } else {
        var x = rel * 126;
        var z = Math.abs(rel) * -120;
        var rotate = rel * -20;
        var scale = rel === 0 ? 1 : 0.9;
        card.style.transform = "translateX(-50%) translate3d(" + x + "px, 0, " + z + "px) rotateY(" + rotate + "deg) scale(" + scale + ")";
        card.style.opacity = rel === 0 ? "1" : "0.92";
        card.style.zIndex = String(100 - Math.abs(rel));
      }

      card.setAttribute("aria-hidden", rel === 0 ? "false" : "true");
      card.tabIndex = rel === 0 ? 0 : -1;
    });
    updatePositionBanner();
  }

  function render() {
    if (mobileQuery.matches) {
      renderStatic();
      return;
    }
    render3d();
  }

  function move(step) {
    activeIndex = mod(activeIndex + step, cards.length);
    render();
  }

  function activateCard(index) {
    activeIndex = mod(index, cards.length);
    render();
  }

  function stopAutoRotate() {
    if (autoRotateTimer) {
      clearInterval(autoRotateTimer);
      autoRotateTimer = null;
    }
  }

  function startAutoRotate() {
    stopAutoRotate();
    if (cards.length < 2 || reducedMotionQuery.matches || mobileQuery.matches) return;
    autoRotateTimer = setInterval(function () {
      move(1);
    }, autoRotateInterval);
  }

  function syncAutoRotate() {
    if (reducedMotionQuery.matches || mobileQuery.matches) {
      stopAutoRotate();
      return;
    }
    startAutoRotate();
  }

  function onMediaChange() {
    render();
    syncAutoRotate();
  }

  function bindMediaChange(query, handler) {
    if (query.addEventListener) {
      query.addEventListener("change", handler);
    } else if (query.addListener) {
      query.addListener(handler);
    }
  }

  prevBtn.addEventListener("click", function () {
    move(-1);
    startAutoRotate();
  });

  nextBtn.addEventListener("click", function () {
    move(1);
    startAutoRotate();
  });

  cards.forEach(function (card, index) {
    card.addEventListener("click", function (event) {
      if (mobileQuery.matches) return;
      if (index === activeIndex) return;
      event.preventDefault();
      event.stopPropagation();
      activateCard(index);
      startAutoRotate();
    });
  });

  carousel.addEventListener("keydown", function (event) {
    if (event.key === "ArrowLeft") {
      event.preventDefault();
      move(-1);
      startAutoRotate();
    } else if (event.key === "ArrowRight") {
      event.preventDefault();
      move(1);
      startAutoRotate();
    }
  });

  carousel.addEventListener("mouseenter", stopAutoRotate);
  carousel.addEventListener("mouseleave", syncAutoRotate);
  carousel.addEventListener("focusin", stopAutoRotate);
  carousel.addEventListener("focusout", function (event) {
    if (!carousel.contains(event.relatedTarget)) {
      syncAutoRotate();
    }
  });

  bindMediaChange(reducedMotionQuery, onMediaChange);
  bindMediaChange(mobileQuery, onMediaChange);

  render();
  syncAutoRotate();
})();
</script>
{{ end }}
