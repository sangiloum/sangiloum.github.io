{{- $posts := .posts -}}
{{- $categoryFilter := .category_filter | default "" -}}
{{- $yearFilter := .year_filter | default "" -}}
{{- $extraClass := .class | default "" -}}
{{- $useFullExcerpt := in $extraClass "post-cards-masonry" -}}
<div class="post-cards{{ with $extraClass }} {{ . }}{{ end }}">
{{- $visibleCount := 0 -}}
{{- range $posts -}}
  {{- $show := true -}}
  {{- if ne $categoryFilter "" -}}
    {{- $show = in (.Params.categories | default (slice)) $categoryFilter -}}
  {{- end -}}
  {{- if $show -}}
    {{- $visibleCount = add $visibleCount 1 -}}
    {{- $postLink := .RelPermalink -}}
    {{- $featured := or .Params.featured_image .Params.featuredImage -}}
    {{- if and (not $featured) $useFullExcerpt -}}
      {{- $featured = "/images/note.jpg" -}}
    {{- end -}}
    {{- if ne $categoryFilter "" -}}
      {{- $postLink = printf "%s?category=%s" .RelPermalink ($categoryFilter | urlquery) -}}
    {{- else if ne $yearFilter "" -}}
      {{- $postLink = printf "%s?year=%s" .RelPermalink ($yearFilter | urlquery) -}}
    {{- end -}}
    <article class="post-card{{ if not $featured }} post-card--no-image{{ end }}">
      {{ if $featured }}
      <a class="post-card-image-link" href="{{ $postLink }}" aria-label="{{ .Title }}">
        {{ partial "responsive-image.html" (dict "src" $featured "alt" .Title "class" "post-card-image markdown-image" "page" . "sizes" "(min-width: 1200px) 360px, (min-width: 900px) 33vw, 100vw") }}
      </a>
      {{ end }}
      <div class="post-card-body">
        <h3 class="post-card-title"><a href="{{ $postLink }}">{{ .Title }}</a></h3>
        <div class="post-card-meta-row">
          <p class="post-card-date">{{ .Date.Format "2006-01-02" }}</p>
          {{ with .Params.categories }}
          <p class="post-card-categories">{{ range . }}<a class="category-chip" href="/blog/category/{{ . | urlize }}/">{{ . }}</a>{{ end }}</p>
          {{ end }}
        </div>
        <p class="post-card-excerpt">{{ if $useFullExcerpt }}{{ .Summary | plainify }}{{ else }}{{ .Summary | plainify | truncate 180 }}{{ end }}</p>
      </div>
    </article>
  {{- end -}}
{{- end -}}
</div>
{{ if eq $visibleCount 0 }}<div class="blog-empty-message">No posts found for this category.</div>{{ end }}
