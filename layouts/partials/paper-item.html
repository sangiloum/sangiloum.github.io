{{- $paper := .paper -}}
{{- $titleHref := "" -}}
{{- if $paper.link -}}
  {{- $titleHref = $paper.link -}}
{{- else if $paper.doi -}}
  {{- $titleHref = printf "https://doi.org/%s" $paper.doi -}}
{{- else if $paper.arxiv -}}
  {{- $titleHref = printf "https://arxiv.org/abs/%s" $paper.arxiv -}}
{{- else if and $paper.url (in $paper.url "://") -}}
  {{- $titleHref = $paper.url -}}
{{- end -}}
{{- $monthNames := slice "" "January" "February" "March" "April" "May" "June" "July" "August" "September" "October" "November" "December" -}}
{{- $monthNum := int (default 0 $paper.month) -}}
{{- $monthName := "" -}}
{{- if and (ge $monthNum 1) (le $monthNum 12) -}}
  {{- $monthName = index $monthNames $monthNum -}}
{{- end -}}
{{- $coauthors := $paper.coauthors | default (slice) -}}
{{- $coauthorIDs := delimit $coauthors "," -}}
{{- $journalText := $paper.journal | default "" -}}
<li class="paper-item" data-year="{{ $paper.year }}" data-coauthors="{{ $coauthorIDs }}" data-journal="{{ $journalText }}">
  <div class="paper-item-main">
    {{- if ne $titleHref "" -}}<a href="{{ $titleHref }}"><strong>{{ $paper.title }}</strong></a>{{- else -}}<strong>{{ $paper.title }}</strong>{{- end -}}
    {{ if gt (len $coauthors) 0 }} (with {{ range $i, $cid := $coauthors }}{{ if gt $i 0 }}{{ if eq $i (sub (len $coauthors) 1) }}{{ if gt (len $coauthors) 2 }}, and {{ else }} and {{ end }}{{ else }}, {{ end }}{{ end }}{{ partial "person-name.html" (dict "id" $cid "link" true) | safeHTML }}{{ end }}){{ end }}
    {{- if ne $journalText "" -}}, <em>{{ $journalText }}</em>{{- end -}}
    {{- with $paper.text -}}, {{ . | markdownify | strings.TrimPrefix "<p>" | strings.TrimSuffix "</p>" | safeHTML }}{{- end -}},
    {{- with $monthName }} {{ . }}{{ end }} {{ $paper.year }}.
    {{- with $paper.note }} {{ . | markdownify | strings.TrimPrefix "<p>" | strings.TrimSuffix "</p>" | safeHTML }}.{{- end -}}
  </div>
  {{- if or $paper.doi $paper.arxiv -}}
  <div class="paper-item-links">
    {{- with $paper.doi -}}<a class="paper-meta-link paper-meta-link-doi" data-label="doi" href="https://doi.org/{{ . }}"><span class="paper-meta-value"><span class="paper-copy-hidden">https://doi.org/</span>{{ . }}</span></a>{{- end -}}
    {{- with $paper.arxiv -}}<a class="paper-meta-link paper-meta-link-arxiv" data-label="arXiv" href="https://arxiv.org/abs/{{ . }}"><span class="paper-meta-value"><span class="paper-copy-hidden">https://arxiv.org/abs/</span>{{ . }}</span></a>{{- end -}}
  </div>
  {{- end -}}
</li>
